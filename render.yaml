services:
  # ── Node.js Image Backend ───────────────────────────────────────────────
  - type: web
    name: allfilechanger-node-backend
    runtime: node
    rootDir: backend/node-server
    buildCommand: npm ci --omit=dev
    startCommand: node server.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: CORS_ORIGIN
        sync: false
    healthCheckPath: /health

  # ── Python PDF/Doc Backend ──────────────────────────────────────────────
  - type: web
    name: allfilechanger-python-backend
    runtime: python
    rootDir: backend/python-server
    buildCommand: pip install -r requirements.txt
    startCommand: gunicorn app:app --bind 0.0.0.0:$PORT --workers 4 --timeout 120
    envVars:
      - key: FLASK_ENV
        value: production
      - key: CORS_ORIGIN
        sync: false
    healthCheckPath: /health

staticSites:
  - name: allfilechanger-frontend
    buildCommand: npm install --legacy-peer-deps && npm run build
    publishPath: dist
    envVars:
      - key: VITE_NODE_API_URL
        sync: false
      - key: VITE_PYTHON_API_URL
        sync: false
    headers:
      - path: /*
        name: Security Headers
        headers:
          - key: X-Frame-Options
            value: DENY
          - key: X-Content-Type-Options
            value: nosniff
          - key: Referrer-Policy
            value: strict-origin-when-cross-origin
          - key: Permissions-Policy
            value: camera=(), microphone=(), geolocation=()
      - path: /assets/*
        name: Cache Assets
        headers:
          - key: Cache-Control
            value: public, max-age=31536000, immutable
