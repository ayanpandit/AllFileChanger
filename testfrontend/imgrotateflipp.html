<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Image Editor</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 30px; background: #f4f4f4; }
    canvas { border: 2px solid black; margin-top: 20px; max-width: 100%; }
    .controls button { margin: 5px; padding: 8px 16px; }
  </style>
</head>
<body>
  <h1>üñºÔ∏è Image Editor</h1>
  <input type="file" id="upload" accept="image/*"><br><br>
  <div class="controls">
    <button onclick="rotate(-90)">‚ü≤ Left</button>
    <button onclick="rotate(90)">‚ü≥ Right</button>
    <button onclick="flip('horizontal')">‚áã Flip H</button>
    <button onclick="flip('vertical')">‚áÖ Flip V</button>
    <button onclick="uploadToServer()">‚¨áÔ∏è Download</button>
  </div>
  <canvas id="canvas"></canvas>

  <script>
    const upload = document.getElementById('upload');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    let img = new Image();
    let angle = 0;
    let flipX = 1;
    let flipY = 1;
    let originalImageFile = null;

    upload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      originalImageFile = file;
      const reader = new FileReader();
      reader.onload = (event) => {
        img.onload = () => {
          resetTransforms();
          drawImage();
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    function resetTransforms() {
      angle = 0;
      flipX = 1;
      flipY = 1;
    }

    function drawImage() {
      const radians = angle * Math.PI / 180;
      const sin = Math.abs(Math.sin(radians));
      const cos = Math.abs(Math.cos(radians));
      const width = img.width;
      const height = img.height;
      const newWidth = width * cos + height * sin;
      const newHeight = width * sin + height * cos;

      canvas.width = newWidth;
      canvas.height = newHeight;

      ctx.save();
      ctx.translate(newWidth / 2, newHeight / 2);
      ctx.rotate(radians);
      ctx.scale(flipX, flipY);
      ctx.drawImage(img, -width / 2, -height / 2);
      ctx.restore();
    }

    function rotate(deg) {
      angle = (angle + deg) % 360;
      drawImage();
    }

    function flip(axis) {
      if (axis === 'horizontal') flipX *= -1;
      if (axis === 'vertical') flipY *= -1;
      drawImage();
    }

    function uploadToServer() {
      if (!originalImageFile) return alert("Upload an image first!");

      const formData = new FormData();
      formData.append('image', originalImageFile);
      formData.append('rotate', angle);
      formData.append('flipX', flipX === -1);
      formData.append('flipY', flipY === -1);

      fetch('/process', {
        method: 'POST',
        body: formData
      })
        .then(res => res.blob())
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'edited-image.png';
          a.click();
          window.URL.revokeObjectURL(url);
        })
        .catch(err => {
          alert("Failed to process image");
          console.error(err);
        });
    }
  </script>
</body>
</html>
